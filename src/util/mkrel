#!/bin/sh
repository=/afs/athena.mit.edu/astaff/project/krbdev/.cvsroot
dodoc=t
dosrc=t
checkout=t
while test $# -gt 2; do
	case $1 in
	--srconly)
		dodoc=nil;;
	--doconly)
		dosrc=nil;;
	--repository)
		shift; repository=$1;;
	--nocheckout)
		checkout=nil;;
	esac
	shift
done
if test $# -lt 2; then
	echo "usage: $0 [opts] release-tag release-dir"
	exit 1
fi

reltag=$1
reldir=$2

case reldir in
*/*)
	echo "release-dir may not contain slashes."
	exit 1
	;;
*);;
esac

if test ! -d $reldir; then
	mkdir $reldir
fi

echo "Checking out krb5 with tag $reltag into directory $reldir..."
if test $checkout = t; then
	(cd $reldir; cvs -q -d $repository export -r$reltag krb5)
fi

if test $dosrc = t; then
	echo "Building autoconf..."
	(cd $reldir/src/util/autoconf
		M4=gm4 ./configure
		make)

	echo "Creating configure scripts..."
	(cd $reldir/src; util/reconf)

	echo "Cleaning src/util/autoconf..."
	(cd $reldir/src/util/autoconf; make distclean)
fi

echo "Nuking unneeded files..."
find $reldir \( -name TODO -o -name todo -o -name .cvsignore \
	-o -name BADSYMS -o -name .Sanitize \) -print \
	| xargs rm -f

if test $dodoc = t; then
	echo "Building doc..."
	(cd $reldir/doc; make)
fi

echo "Generating tarfiles..."
if test $dosrc = t; then
	gtar --exclude $reldir/src/lib/crypto \
		--exclude $reldir/src/lib/des425 \
		--exclude $reldir/doc \
		-zcf ${reldir}.src.tar.gz $reldir

	gtar zcf ${reldir}.crypto.tar.gz \
		$reldir/src/lib/crypto \
		$reldir/src/lib/des425
fi

if test $dodoc = t; then
	gtar zcf ${reldir}.doc.tar.gz $reldir/doc $reldir/README
fi

ls -l ${reldir}.*.tar.gz

echo "Done."

exit 0
