<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3c.org/TR/1999/REC-html401-19991224/loose.dtd">
<!-- saved from url=(0066)https://confab.mit.edu/confluence/display/ISDA/lore-bkw-automation -->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
        <title>lore-bkw-automation - Confluence</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta http-equiv="Pragma" content="no-cache" />
        <meta http-equiv="Expires" content="-1" />
        <link href="css/main-action.css" type="text/css" rel="stylesheet" />
        <link href="css\main-action(1).css" type="text/css" rel="stylesheet" />
        <meta content="MSHTML 6.00.2900.3059" name="GENERATOR" />
</head>
    <body>
        <div style="MARGIN-LEFT: 10px; MARGIN-RIGHT: 10px" align="left">
            <div class="wiki-content" style="MARGIN-TOP: 5px; MARGIN-BOTTOM: 5px" align="left">The 
                Kerberos for Windows (KfW) build is automated.&nbsp; A script will fetch the 
                sources from a repository and then build, sign and package all the KfW 
                distribution components.
            </div>
            <div class="wiki-content" style="MARGIN-TOP: 5px; MARGIN-BOTTOM: 5px" align="left">This 
                description consists of
            </div>
            <ul>
                <li><a href="#Environment">Setting up the build environment</a></li>
                <li><a href="#Running">Running the script</a></li>
                <li><a href="Details">Script internal details</a></li>
                <li><a href="#Remainingwork">Remaining work / bug list</a></li>
                <li><a href="#64bitbuilds">64 bit builds</a></li>
                <li><a href="#Troubleshooting">Troubleshooting</a></li>
            </ul>
            <h2>Setting Up the Build Environment</h2>
            <p>KfW is built on a Windows PC, in the default Windows shell (cmd.exe). These 
                components must be installed:</p>
            <ul>
                <li>Visual Studio 2003<br />
                    Versions of Visual Studio before or after 2003 are not supported.</li>
                <li>A recent release of the
                    <span class="nobr">
                    <a href="http://www.microsoft.com/downloads/details.aspx?FamilyId=0BAF2B35-C656-4969-ACE8-E4C0C0716ADB&amp;displaylang=en">
                        Microsoft Platform SDK</a></span>
                    &nbsp;</li>
                <li><span class="nobr">
                    <a title="Visit page outside Confluence" href="http://www.activestate.com" rel="nofollow">
                        ActiveState Perl 5.8 or more recent</a></span><br />
                        Build 631 is known to work.</li>
                <li><span class="nobr">
                    <a title="Visit page outside Confluence" href="http://www.doxygen.org/" rel="nofollow">
                        Doxygen</a></span></li>
                <li>sed, awk, cat, rm and find<br />
                    These can be obtained from the
                    <span class="nobr">
                        <a title="Visit page outside Confluence" href="http://cygwin.com/" rel="nofollow">Cygwin 
                            distribution</a></span>.
                    <br clear="all" />
                    <br clear="all" />
                    find must be in C:\tools\cygwin\bin, so install Cygwin in C:\tools\cygwin.
                    <br />
                    <br />
                    The cygwin awk is a link and the MS shell doesn't deal well with that.&nbsp; <tt>C</tt>opy <tt>c:\tools\cygwin\bin\gawk</tt> to <tt>c:\tools\cygwin\bin\awk</tt>.</li>
                <li><span class="nobr">
                    <a title="Visit page outside Confluence" href="http://sourceforge.net/project/showfiles.php?group_id=105970"
                        rel="nofollow">Wix</a></span></li>
                <li><span class="nobr">
                    <a title="Visit page outside Confluence" href="http://nsis.sourceforge.net" rel="nofollow">
                        NSIS</a></span></li></ul>
            <h3>Environment variables</h3>
            <p>
                All the components above must be in PATH. Installing ActivePerl puts perl in 
                the PATH. Doxygen, Cygwin, hhc, wix and&nbsp;nsis need to be added.</p>
            <p>perl must be installed so that .pl files are automatically executed with perl. 
                The ActivePerl installation will do this for you.</p>
            <p>In the INCLUDE path, the Microsoft Platform SDK must come before the Microsoft 
                Visual C++ include files. In the PATH path, the Platform SDK bin area must come before the Visual Studio VC\bin area. Using a Platform SDK Build Environment window will 
                set this up the right way.&nbsp; Make sure to use a Platform SDK Windows XP Build Environment shell. </p>
            <p>If you make your path modifications permanent via Control Panel / System / 
                Advanced / Environment Variables:&nbsp; If you use a Platform SDK Build 
                Environment window, it appears that you need to put your PATH components in the 
                System PATH, not the User PATH.</p>
            <p>Visual Studio installs hhc in C:\Program Files\HTML Help Workshop.</p>
            <p>nmake must be in PATH. If you use a Platform SDK build environment window, it is 
                already done for you.</p>
            <h2>Running the Script<a name="Running"></a></h2>
            <p> The build is a perl script controlled by command line switches and an XML 
                configuration file. The config file is required. Settings in the config file 
                can be overridden by optional command line switches.</p>
            <p>There are options for controlling most steps of the build process.&nbsp; The 
                steps are</p>
            <ul>
                <li>Verifying the environment</li>
                <li>Fetching the sources from repositories</li>
                <li>Building the sources</li>
                <li>Setting up the packaging environment</li>
                <li>Building the installers</li>
                <li>Building the rest of the components</li>
            </ul>
            <p>The usage message shows the switches that control these steps:</p>
            <p><tt>C:\Projects\KfW&gt;perl bkw.pl /?</tt><br />
                <tt>Usage: bkw.pl [options] NMAKE-options</tt></p>
            <p><tt>&nbsp; Options are case insensitive. </tt></p>
            <p><tt>&nbsp; Options:&nbsp;<br /></tt>
               <tt>&nbsp; /help /?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
                   usage information (what you now see).<br />
                   &nbsp; /config /f path&nbsp;&nbsp; Path to config file. Default is 
                   bkwconfig.xml.<br />
                   &nbsp; /src /s dir&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Source directory to use. 
                   Should contain <br />
                   &nbsp;&nbsp;&nbsp; 
                   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
                   pismere/athena. If cvstag or svntag is&nbsp;null,<br />
                   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
                   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
                   the directory should be prepopulated.<br />
                   &nbsp; /out /o dir&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Directory to be created 
                   where build results will go<br />
                   &nbsp; /cpu /p cputype &nbsp; CPU type [i386 | AMD64]</tt><tt><br />
                   </tt>
                <tt>&nbsp; /repository checkout | co \ What repository action to take.<br />
                   &nbsp;&nbsp;&nbsp; &nbsp;/r&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
                   update&nbsp;&nbsp; | up&nbsp;\ Options are to checkout, update, export<br />
                   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;export&nbsp;&nbsp; 
                   | ex \ or take no action [skip].&nbsp;<br />
                   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
                   skip<br />
                   &nbsp; /username /u name username used to access svn if checking out.
                   <br />
&nbsp; /cvstag /c tag&nbsp;&nbsp;&nbsp; use -r &lt;tag&gt; in cvs command <br />
&nbsp; /svnbranch /b tag use /branches/&lt;tag&gt; instead of /trunk.<br />
&nbsp; /svntag /t tag&nbsp;&nbsp;&nbsp; use /tags/&lt;tag&gt; instead of /trunk.<br />
&nbsp; /debug /d&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Do&nbsp;debug make instead of 
release make. <br />
&nbsp; /[no]make&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
Control the make step.<br />
&nbsp; /clean&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Build 
clean target. <br />
&nbsp; /[no]package&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Control the packaging step. <br />
&nbsp; /[no]sign&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Control signing 
of executable&nbsp;files. <br />
&nbsp; /verbose /v&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Debug mode - verbose output.&nbsp;<br />
                    &nbsp; /vverbose &nbsp; &nbsp; &nbsp; &nbsp; Debug mode - very verbose output.&nbsp;<br />
&nbsp; /logfile /l path&nbsp; Where to write output. Default is bkw.pl.log. <br />
&nbsp; /nolog&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Don't save output. 
</tt>
</p>
            <p><tt>&nbsp; Other:
                   <br />
                    &nbsp;&nbsp;&nbsp; NMAKE-options any options you want to pass to NMAKE, which 
                    can be:
                    <br />
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
                    (note: /nologo is always used)<br />
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NODEBUG=1</tt></p>
            <p><tt>NMAKE-options any options you want to pass to NMAKE, which can be:</tt><br />
                <tt>(note: /nologo is always used)</tt><br />
                <tt>[ nmake options follow ]</tt></p>
            <p><br />Notes on the script steps:</p>
            <p><strong>Verifying the environment</strong>:&nbsp;
                <br />
                The script tests for each program that it needs and warns if the program isn't 
                found.</p>
            <p><strong>Fetching sources from repositories</strong>:&nbsp;
                <br />
                If building from a source distribution kit, this section does not apply.</p>
            <p>CVSROOT and SVNURL must be specified in the configuration file.</p>
            <p>A source zip file can only be produced if checking out fresh sources from a 
                repository.&nbsp;</p>
            <p>If checking out, the entire pismere directory will be deleted.&nbsp; A warning 
                message requires that you confirm this action.</p>
            <p><strong>Building the sources:</strong><br />
                /DEBUG controls whether a debug or release build is done.&nbsp; /CLEAN will 
                build the CLEAN target.</p>
            <p><strong>Setting up the packaging environment :<br />
                </strong>The pre-package steps gathers up build results and puts them in a <font face="Courier">
                    staging</font> area.&nbsp;
            </p>
            <p>If /SIGN is specified, <font face="Courier">.exe</font>s, <font face="Courier">.dll</font>s 
                and <font face="Courier">.cpl</font>s are signed.&nbsp; The signing command 
                template is in the configuration file.</p>
            <p><strong>Building the installers:</strong><br />
                The <font face="Courier">staging </font>area is copied into a fresh area for 
                each of the installers.&nbsp; The installer results are copied back to the <font face="Courier">
                    staging </font>area.</p>
            <p><strong>Building the rest of the components:</strong><br />
                Zip files are built in temporary areas and copied to <font face="Courier">outdir</font>.&nbsp; 
                The installers and assorted files are copied from <font face="Courier">staging</font>
                to <font face="Courier">outdir</font>.&nbsp; If /SIGN is specified, the 
                installers will be signed.</p>
            <p>&nbsp;</p>
            <h2><a name="Details"></a>Script Internal Details</h2>
            <h3><a name="Copylists"></a>Copy Lists</h3>
            <p>CopyLists are used in many places.&nbsp;&nbsp;For example, files to be put into 
                a .zip are copied to a fresh directory which is then zipped up.&nbsp; There is 
                an optional Configuration section and a required Files section.&nbsp;</p>
            <p>The configuration section defines the roots of the from and to paths and can 
                optionally define path substitutions.&nbsp;
            </p>
            <p>The to and from paths are forced by the script rather than being set in the 
                config file.&nbsp; Comments in the copyfile xml indicate this.</p>
            <p>Lengthy copy lists can be kept in separate files and included with the Include 
                directive.&nbsp; Example:</p>
            <p><tt>&lt;Include path="sdkfiles.xml" /&gt;</tt></p>
            <h3>Substitution tags</h3>
            <p>Filenames in copylists can contain variable 'tags' that are replaced before the 
                file is copied.&nbsp; Some configuration files contain substitution tags which 
                customize the configuration.&nbsp; The supported tags are</p>
                <table id="Table3" cellspacing="1" cellpadding="1" border="1">
                    <tr>
                        <td width="136">%VERSION_MAJOR%</td>
                        <td height="21">KfW Version from pismere/athena/include/kerberos.ver.</td>
                    </tr>
                    <tr>
                        <td width="136">%VERSION_MINOR%</td>
                        <td height="9">KfW Version from pismere/athena/include/kerberos.ver.</td>
                    </tr>
                    <tr>
                        <td width="136">%VERSION_PATCH%</td>
                        <td height="17">KfW Version from pismere/athena/include/kerberos.ver.</td>
                    </tr>
                    <tr>
                        <td width="136">%filestem%</td>
                        <td height="17">Defined as kfw-%VERSION_MAJOR%-%VERSION_MINOR%-%VERSION_PATCH%.</td>
                    </tr>
                    <tr>
                        <td width="136">%debug%</td>
                        <td>'dbg.'&nbsp; Only substituted during a debug build.&nbsp;</td>
                    </tr>
                    <tr>
                        <td width="136">%release%</td>
                        <td>'rel.'&nbsp; Only substituted during a release build.&nbsp;
                        </td>
                    </tr>
                    <tr>
                        <td width="136">%bldtype%</td>
                        <td>Always substituted, to 'dbg' or 'rel,' depending on the type of build.</td>
                    </tr>
                    <tr>
                        <td width="136">%cpu%</td>
                        <td>Always substituted, to the value of the /cpu argument, or the value of the CPU environment variable, if /cpu isn't specified, or to 'i386' if the CPU environment variable isn't specified.</td>
                    </tr>
                    <tr>
                        <td width="136">
                            %WL%</td>
                        <td>
                            Word length.&nbsp; If CPU is i386, '32' will be substituted; otherwise '64' will
                            be substituted.</td>
                    </tr>
                    <tr>
                        <td width="136">%-DEBUG%</td>
                        <td>'-DEBUG' during a debug build; otherwise empty.</td>
                    </tr>
                    <tr>
                        <td width="136">%BUILDDIR%</td>
                        <td>SRCDIR\pismere.&nbsp; Used in site-local installer configuration files.</td>
                    </tr>
                    <tr>
                        <td width="136">%TARGETDIR%</td>
                        <td>SRCDIR\pismere\staging.&nbsp; Used in site-local installer configuration files.</td>
                    </tr>
                    <tr>
                        <td width="136">%CONFIGDIR-WIX%</td>
                        <td>SRCDIR\pismere\staging\sample.&nbsp; Used in site-local installer configuration 
                            files.</td>
                    </tr>
                    <tr>
                        <td width="136">%CONFIGDIR-NSI%</td>
                        <td>SRCDIR\pismere\staging.&nbsp; Used in site-local installer configuration files.</td>
                    </tr>
                </table>
            <p>The overall build configuration specifies a debug or release build.&nbsp; Debug 
                and release results are put in different places.&nbsp; Files whose location 
                depend on the build type can use %bldtype% in their names.&nbsp; The script 
                will substitute %bldtype% with either dbg or rel, depending on the build 
                type.</p>
        </div>
    <div style="MARGIN-LEFT: 10px; MARGIN-RIGHT: 10px" align="left">
            <h3>Example</h3>
            <p>Here is&nbsp;a copylist entry.&nbsp; Each segment of the file's path that comes 
                from a different place is in a different color.</p>
            <p>Release build.&nbsp; Config file:</p>
          <table id="Table2" cellspacing="1" cellpadding="1" border="0">
                    <tr>
                        <td colspan="4"><font face="courier">&lt;BKW_Config&gt;</font></td>
                    </tr>
                    <tr>
                        <td width="23"></td>
                        <td colspan="3"><font face="courier">&lt;Config&gt;</font></td>
                    </tr>
                    <tr>
                        <td width="23"></td>
                        <td width="20"></td>
                        <td><font face="courier">&lt;src&nbsp;value ="<font color="#000099">C:\bkw"</font> /&gt;</font>
                        </td>
                    </tr>
          </table>
            <p>Copylist comments:</p>
            <p><tt>&lt;!-- File from paths are relative to
                    &lt;src&gt;\<font color="#ff00cc">pismere\athena</font> --&gt; <br />&lt;!-- File to paths are relative to &lt;src&gt;\<font color="#00ff00">
                    pismere\staging</font>
                    --&gt; </tt></p>
            <p>When the script processes this copylist, it will force the from and to paths as 
                indicated.</p>
            <p>This line</p>
            <p><tt>&lt;File name="<font color="#00ffff">comerr32.dll</font>" from="<font color="#ff9933">..\target\bin\%cpu%</font>\<font color="#ff0000">%bldtype%</font>\" 
                    to="\<font color="#9966ff">bin\%cpu%</font>" /&gt;</tt></p>
            <p>will result in <font face="Courier"><font color="#000099">C:\bkw</font>\<font color="#ff00cc">pismere\athena</font>\<font color="#ff9933">..\target\bin\i386</font>\<font color="#ff0000">rel</font>\<font color="#00ffff">comerr32.dll</font></font></p>
            <p>being copied to <font face="Courier"><font color="#000099">C:\bkw</font>\<font color="#00ff00">pismere\staging</font>\<font color="#9966ff">bin\i386</font>\<font color="#00ffff">comerr32.dll</font></font>.</p>
            <p>Other possible attributes in a copylist entry:</p>
            <ul>
                <li><tt>notrequired</tt></li>
                <li><tt>newname="filename"</tt></li>
                </ul>
            <p>By default, copylist entries are required and the script will die if they aren't 
                present. To ignore missing files, add <tt>notrequired</tt>.</p>
            <p>To rename the file, set the <tt>newname</tt> attribute.</p>

            <h2><font face="Verdana"><a name="64bitbuilds"></a>64 bit builds</font></h2>
            <p>
                To build a 64 bit version, several things must be done:</p>
        <ul>
            <li>Set the CPU environment variable to AMD64.</li>
            <li>run Program Files (x86)\Microsoft Visual Studio 8\VC\vcvarsall.bat with the argument 'AMD64.'&nbsp; </li>
            <li>Run bkw.pl with /cpu AMD64 /components "base AMD64"</li>
        </ul>
        <p>If you get errors in the CCAPI part of the build that symbols have been multiply declared, it means you changed the build target between i386 and AMD64 without doing
            a <strong>bkw.pl clean </strong>in between.&nbsp;
        </p>

            <h2><font face="Verdana"><a name="Remainingwork"></a>Remaining Work / Bug List</font></h2>
            <p>Implement RETAIL, OFFICIAL, PRERELEASE, PRIVATE, SPECIAL.</p>
            <p>Figure out what MIT_ONLY, BUILD_KFW, DEBUG_SYMBOL should be.</p>
            <p>TARGET, APPVER.</p>
            <p>NODEBUG=1.&nbsp; Set if release build.</p>
            <h2><font face="Verdana"><a name="Troubleshooting"></a>Troubleshooting</font>
            </h2>
            <p><strong>Can't clean directory; can't delete file or directory</strong><br />
                Make sure a file in the named directory isn't open in another application.</p>
        <p><strong>Can't find kerberos.ver</strong><br />
            You skipped the repository step and are trying to build in an empty directory.</p>
        <p><strong>Directories don't exist or can't be created <br />
        </strong>This can be a symptom of the Platform SDK bin area not being before the Visual Studio bin areas, such that the version of nmake running is version 8.x.<br />
        [This explanation courtesy of Jeff Altman]: <br />
        nmake V8 appears to favor executables over shell commands. As a result, using 'mkdir' instead of 'md' in Makefiles, as a command for creating directory trees, fails when the Cygwin mkdir.exe is present in the PATH. Changing the</p>
        <p>MKDIR=mkdir<br />
        RMDIR=rmdir</p>
        <p>macros in the Makefiles to</p>
        <p>MKDIR=md<br />
        RMDIR=rd</p>
        <p>should make the shell versions execute in all cases.</p>
        <p><strong>CCAPI test directory doesn't build after changing CPU type</strong><br />
            Make clean might not be cleaning everything out.&nbsp; Carefully remove any source
            files that are copied from lib or server and cached in the test directory.</p>
    </div>
    </body>
</html>
