CFLAGS = $(CCOPTS) $(DEFS)

##DOSBUILDTOP = ..
##DOSVERS_DIR = \vers

MAC_SUBDIRS = crypto krb5 gssapi kadm

all-unix::

all-mac::

CLEANLIBS = libkrb5.a libkdb5.a libcrypto.a libgssapi_krb5.a libdes425.a \
	libkrb425.a libkadm.a libkrb4.a libcom_err.a libpty.a \
	libss.a libkrb5util.a libgssapi.a \
	libkrb5.so libcrypto.so libkrb4.so libdes425.so

clean-mac:: clean-unix
clean-unix::
	$(RM) $(CLEANLIBS)

clean-windows::
	$(RM) krb5_16.dll krb5_16.lib krb5_16.bak krb5_16.map winsock.lib
	$(RM) gssapi.dll gssapi.lib gssapi.bak gssapi.map
#
# Windows stuff to make krb5_16.dll and krb5_16.lib. Currently it
# combines crypto, krb5, kadm and the util/et directories.
#
ALIB  = kadm\kadm.lib
CLIB  = crypto\crypto.lib
KLIB  = krb5\krb5.lib
GLIB  = gssapi\gssapi.lib
ETLIB = $(BUILDTOP)\util\et\comerr.lib
PLIB  = $(BUILDTOP)\util\profile\profile.lib
WLIB  = .\winsock.lib
LIBS  = $(ALIB) $(CLIB) $(KLIB) $(GLIB) $(ETLIB) $(PLIB) $(WLIB)

lib-windows: winsock.lib krb5_16.lib gssapi.lib 

gssapi.lib:: gssapi.dll
	implib /nologo gssapi.lib gssapi.dll

gssapi.dll:: $(GLIB) $(LIBS) gssapi.def win_glue.obj
	link /co /seg:400 /noe /nod /nol win_glue, gssapi.dll, gssapi.map, \
	   $(LIBS) ldllcew libw oldnames, gssapi.def
	rc /nologo /p /k gssapi.dll

krb5_16.lib:: krb5_16.dll
	implib /nologo krb5_16.lib krb5_16.dll

krb5_16.dll:: $(LIBS) krb5_16.def win_glue.obj
	link /co /seg:400 /noe /nod /nol win_glue, krb5_16.dll, krb5_16.map, \
	   $(LIBS) ldllcew libw oldnames, krb5_16.def
	rc /nologo /p /k krb5_16.dll

sap_glue.obj: win_glue.c
	$(CC) $(CFLAGS) -DSAP_TIMEBOMB -I$(VERS_DIR) /c \
		/Fosap_glue.obj win_glue.c

win_glue.obj: win_glue.c
	$(CC) $(CFLAGS) /c win_glue.c

sapkrb5.dll:: $(GLIB) $(LIBS) gssapi.def sap_glue.obj
	link /co /seg:400 /noe /nod /nol sap_glue, sapkrb5.dll, sapkrb5.map, \
	   $(LIBS) $(VERS_DIR)\vswin.lib ldllcew libw oldnames, sapkrb5.def
	rc /nologo /p /k sapkrb5.dll

winsock.lib:  winsock.def
	implib /nologo winsock.lib winsock.def

all-windows:: 
	@echo Making in lib\crypto
	cd crypto
	-$(MAKE) -$(MFLAGS)
	@echo Making in lib\kadm
	cd ..\kadm
	-$(MAKE) -$(MFLAGS) 
	@echo Making in lib\krb5
	cd ..\krb5
	-$(MAKE) -$(MFLAGS) 
	@echo Making in lib\gssapi
	cd ..\gssapi
	-$(MAKE) -$(MFLAGS) 
	@echo Making in lib
	cd ..

all-windows:: krb5_16.lib gssapi.lib

clean-windows::
	@echo Making clean in lib\crypto
	cd crypto
	-$(MAKE) -$(MFLAGS) clean
	@echo Making clean in lib\kadm
	cd ..\kadm
	-$(MAKE) -$(MFLAGS) clean
	@echo Making clean in lib\krb5
	cd ..\krb5
	-$(MAKE) -$(MFLAGS) clean
	@echo Making clean in lib\gssapi
	cd ..\gssapi
	-$(MAKE) -$(MFLAGS) clean
	@echo Making clean in lib
	cd ..

