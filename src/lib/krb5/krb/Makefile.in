BUILDTOP=./../../$(top_dir)
SRCTOP=$(top_srcdir)/../..

CFLAGS = $(CCOPTS) $(DEFS)
RUN_SETUP = @KRB5_RUN_ENV@

##DOSBUILDTOP = ..\..\..
##DOSLIBNAME=..\krb5.lib

.c.o:
	$(CC) $(CFLAGS) -c $(srcdir)/$*.c
@SHARED_RULE@

OBJS=	addr_comp.$(OBJEXT)	\
	addr_order.$(OBJEXT)	\
	addr_srch.$(OBJEXT)	\
	auth_con.$(OBJEXT)	\
	bld_pr_ext.$(OBJEXT)	\
	bld_princ.$(OBJEXT)	\
	chk_trans.$(OBJEXT)	\
	conv_princ.$(OBJEXT)	\
	copy_addrs.$(OBJEXT)	\
	copy_auth.$(OBJEXT)	\
	copy_athctr.$(OBJEXT)	\
	copy_cksum.$(OBJEXT)    \
	copy_creds.$(OBJEXT)	\
	copy_data.$(OBJEXT)	\
	copy_key.$(OBJEXT)	\
	copy_princ.$(OBJEXT)	\
	copy_tick.$(OBJEXT)	\
	cp_key_cnt.$(OBJEXT)	\
	decode_kdc.$(OBJEXT)	\
	decrypt_tk.$(OBJEXT)	\
	encode_kdc.$(OBJEXT)	\
	encrypt_tk.$(OBJEXT)	\
	free_rtree.$(OBJEXT)	\
	fwd_tgt.$(OBJEXT)	\
	gc_frm_kdc.$(OBJEXT)	\
	gc_via_tkt.$(OBJEXT)	\
	gen_seqnum.$(OBJEXT)	\
	gen_subkey.$(OBJEXT)	\
	get_creds.$(OBJEXT)	\
	get_in_tkt.$(OBJEXT)	\
	in_tkt_ktb.$(OBJEXT)	\
	in_tkt_pwd.$(OBJEXT)	\
	in_tkt_sky.$(OBJEXT)	\
	init_ctx.$(OBJEXT)	\
	kdc_rep_dc.$(OBJEXT)	\
	mk_cred.$(OBJEXT)	\
	mk_error.$(OBJEXT)	\
	mk_priv.$(OBJEXT)	\
	mk_rep.$(OBJEXT)	\
	mk_req.$(OBJEXT)	\
	mk_req_ext.$(OBJEXT)	\
	mk_safe.$(OBJEXT)	\
	parse.$(OBJEXT)		\
	pr_to_salt.$(OBJEXT)	\
	preauth.$(OBJEXT)	\
	princ_comp.$(OBJEXT)	\
	rd_cred.$(OBJEXT)	\
	rd_error.$(OBJEXT)	\
	rd_priv.$(OBJEXT)	\
	rd_rep.$(OBJEXT)	\
	rd_req.$(OBJEXT)	\
	rd_req_dec.$(OBJEXT)	\
	rd_safe.$(OBJEXT)	\
	recvauth.$(OBJEXT)	\
	sendauth.$(OBJEXT)	\
	send_tgs.$(OBJEXT)	\
	ser_actx.$(OBJEXT)	\
	ser_adata.$(OBJEXT)	\
	ser_addr.$(OBJEXT)	\
	ser_auth.$(OBJEXT)	\
	ser_cksum.$(OBJEXT)	\
	ser_ctx.$(OBJEXT)	\
	ser_eblk.$(OBJEXT)	\
	ser_key.$(OBJEXT)	\
	ser_princ.$(OBJEXT)	\
	serialize.$(OBJEXT)	\
	srv_rcache.$(OBJEXT)	\
	str_conv.$(OBJEXT)	\
	tgtname.$(OBJEXT)	\
	unparse.$(OBJEXT)	\
	valid_times.$(OBJEXT)	\
	walk_rtree.$(OBJEXT)

SRCS=	$(srcdir)/addr_comp.c	\
	$(srcdir)/addr_order.c	\
	$(srcdir)/addr_srch.c	\
	$(srcdir)/auth_con.c	\
	$(srcdir)/bld_pr_ext.c	\
	$(srcdir)/bld_princ.c	\
	$(srcdir)/chk_trans.c	\
	$(srcdir)/conv_princ.c	\
	$(srcdir)/copy_addrs.c	\
	$(srcdir)/copy_auth.c	\
	$(srcdir)/copy_athctr.c	\
	$(srcdir)/copy_cksum.c   \
	$(srcdir)/copy_creds.c	\
	$(srcdir)/copy_data.c	\
	$(srcdir)/copy_key.c	\
	$(srcdir)/copy_princ.c	\
	$(srcdir)/copy_tick.c	\
	$(srcdir)/cp_key_cnt.c	\
	$(srcdir)/decode_kdc.c	\
	$(srcdir)/decrypt_tk.c	\
	$(srcdir)/encode_kdc.c	\
	$(srcdir)/encrypt_tk.c	\
	$(srcdir)/free_rtree.c	\
	$(srcdir)/fwd_tgt.c	\
	$(srcdir)/gc_frm_kdc.c	\
	$(srcdir)/gc_via_tkt.c	\
	$(srcdir)/gen_seqnum.c	\
	$(srcdir)/gen_subkey.c	\
	$(srcdir)/get_creds.c	\
	$(srcdir)/get_in_tkt.c	\
	$(srcdir)/in_tkt_ktb.c	\
	$(srcdir)/in_tkt_pwd.c	\
	$(srcdir)/in_tkt_sky.c	\
	$(srcdir)/init_ctx.c	\
	$(srcdir)/kdc_rep_dc.c	\
	$(srcdir)/mk_cred.c	\
	$(srcdir)/mk_error.c	\
	$(srcdir)/mk_priv.c	\
	$(srcdir)/mk_rep.c	\
	$(srcdir)/mk_req.c	\
	$(srcdir)/mk_req_ext.c	\
	$(srcdir)/mk_safe.c	\
	$(srcdir)/parse.c	\
	$(srcdir)/pr_to_salt.c	\
	$(srcdir)/preauth.c	\
	$(srcdir)/princ_comp.c	\
	$(srcdir)/rd_cred.c	\
	$(srcdir)/rd_error.c	\
	$(srcdir)/rd_priv.c	\
	$(srcdir)/rd_rep.c	\
	$(srcdir)/rd_req.c	\
	$(srcdir)/rd_req_dec.c	\
	$(srcdir)/rd_safe.c	\
	$(srcdir)/recvauth.c	\
	$(srcdir)/sendauth.c	\
	$(srcdir)/send_tgs.c	\
	$(srcdir)/ser_actx.c	\
	$(srcdir)/ser_adata.c	\
	$(srcdir)/ser_addr.c	\
	$(srcdir)/ser_auth.c	\
	$(srcdir)/ser_cksum.c	\
	$(srcdir)/ser_ctx.c	\
	$(srcdir)/ser_eblk.c	\
	$(srcdir)/ser_key.c	\
	$(srcdir)/ser_princ.c	\
	$(srcdir)/serialize.c	\
	$(srcdir)/srv_rcache.c	\
	$(srcdir)/str_conv.c	\
	$(srcdir)/tgtname.c	\
	$(srcdir)/unparse.c	\
	$(srcdir)/valid_times.c	\
	$(srcdir)/walk_rtree.c

all-unix:: shared $(OBJS) DONE
DONE: $(OBJS)
	@echo $(OBJS) > DONE

all-mac:: shared $(OBJS)
all-windows:: $(OBJS)

shared:
	mkdir shared

COMERRLIB=$(TOPLIBD)/libcom_err.a

T_WALK_RTREE_OBJS= t_walk_rtree.o walk_rtree.o tgtname.o unparse.o \
	free_rtree.o bld_pr_ext.o 

T_KERB_OBJS= t_kerb.o conv_princ.o unparse.o 

T_SER_OBJS= t_ser.o ser_actx.o ser_adata.o ser_addr.o ser_auth.o ser_cksum.o \
	ser_ctx.o ser_eblk.o ser_key.o ser_princ.o serialize.o 

t_walk_rtree: $(T_WALK_RTREE_OBJS) $(DEPLIBS)
	$(LD) $(LDFLAGS) $(LDARGS) -o t_walk_rtree $(T_WALK_RTREE_OBJS) $(LIBS)

t_kerb: $(T_KERB_OBJS) $(DEPLIBS)
	$(LD) $(LDFLAGS) $(LDARGS) -o t_kerb $(T_KERB_OBJS) $(LIBS)

t_ser: $(T_SER_OBJS) $(DEPLIBS)
	$(LD) $(LDFLAGS) $(LDARGS) -o t_ser $(T_SER_OBJS) $(LIBS)

TEST_PROGS= t_walk_rtree t_kerb t_ser

check-unix:: $(TEST_PROGS)
	KRB5_CONFIG=$(srcdir)/t_krb5.conf ; export KRB5_CONFIG ;\
	$(RUN_SETUP) ./t_kerb 425_conv_principal rcmd e40-po ATHENA.MIT.EDU \
		 425_conv_principal rcmd mit ATHENA.MIT.EDU \
		 425_conv_principal rcmd lithium ATHENA.MIT.EDU \
		 425_conv_principal rcmd tweedledumb CYGNUS.COM \
		 425_conv_principal rcmd uunet UU.NET \
		 425_conv_principal zephyr zephyr ATHENA.MIT.EDU \
		 425_conv_principal kadmin ATHENA.MIT.EDU ATHENA.MIT.EDU \
		> test.out
	cmp test.out $(srcdir)/t_ref_kerb.out
	$(RM) test.out
	$(RUN_SETUP) ./t_ser

check-mac:: $(TEST_PROGS)

check-windows::

clean:: 
	$(RM) t_walk_rtree$(EXEEXT) t_walk_rtree.$(OBJEXT)
	$(RM) t_kerb$(EXEEXT) t_kerb.$(OBJEXT)
	$(RM) t_ser$(EXEEXT) t_ser.$(OBJEXT)

clean-unix::
	$(RM) shared/*
clean-mac::
	$(RM) shared/*
clean-windows::
