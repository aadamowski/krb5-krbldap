CFLAGS = $(CCOPTS)
RUN_SETUP = @KRB5_RUN_ENV@

TEST_DB = ./testdb
TEST_REALM = FOO.TEST.REALM
TEST_MKEY = footes
TEST_NUM = 65
TEST_DEPTH = 5
TEST_PREFIX = "foo bar"

KADMIN_OPTS= -d $(TEST_DB) -r $(TEST_REALM) -P $(TEST_MKEY)
KTEST_OPTS= $(KADMIN_OPTS) -p $(TEST_PREFIX) -n $(TEST_NUM) -D $(TEST_DEPTH)

old-check-unix:: kdb_check

kdb_check:
	$(RM) $(TEST_DB)*
	$(RUN_SETUP) ../admin/create/kdb5_create $(KADMIN_OPTS)
	$(RUN_SETUP) ../tests/create/kdb5_mkdums $(KTEST_OPTS) 
	$(RUN_SETUP) ../tests/verify/kdb5_verify $(KTEST_OPTS) 
	$(RUN_SETUP) ../admin/edit/kdb5_edit $(KADMIN_OPTS) -R "dump_db $(TEST_DB).dump"
	$(RUN_SETUP) ../admin/edit/kdb5_edit $(KADMIN_OPTS) -R "dump_db -old $(TEST_DB).odump"
	$(RUN_SETUP) ../admin/destroy/kdb5_destroy -d $(TEST_DB) -f
	$(RUN_SETUP) ../admin/edit/kdb5_edit -r $(TEST_REALM) -R "load_db $(TEST_DB).dump $(TEST_DB)"
	$(RUN_SETUP) ../tests/verify/kdb5_verify $(KTEST_OPTS) 
	$(RUN_SETUP) ../admin/edit/kdb5_edit $(KADMIN_OPTS) -R "dump_db $(TEST_DB).dump2"
	sort $(TEST_DB).dump > $(TEST_DB).sort
	sort $(TEST_DB).dump2 > $(TEST_DB).sort2
	cmp $(TEST_DB).sort $(TEST_DB).sort2
	$(RUN_SETUP) ../admin/destroy/kdb5_destroy -d $(TEST_DB) -f
	$(RUN_SETUP) ../admin/edit/kdb5_edit -r $(TEST_REALM) -R "load_db -old $(TEST_DB).odump $(TEST_DB)"
	$(RUN_SETUP) ../tests/verify/kdb5_verify $(KTEST_OPTS) 
	$(RUN_SETUP) ../admin/edit/kdb5_edit $(KADMIN_OPTS) -R "dump_db -old $(TEST_DB).odump2"
	sort $(TEST_DB).odump > $(TEST_DB).osort
	sort $(TEST_DB).odump2 > $(TEST_DB).osort2
	cmp $(TEST_DB).osort $(TEST_DB).osort2
	$(RUN_SETUP) ../admin/destroy/kdb5_destroy -d $(TEST_DB) -f
	$(RM) $(TEST_DB)*


